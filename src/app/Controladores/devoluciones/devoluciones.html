<div class="devoluciones-container">
  <div class="header">
    <h1>ğŸ”„ GestiÃ³n de Devoluciones</h1>
    <button class="btn-primary" (click)="nuevaDevolucion()" *ngIf="!modoFormulario">
      â• Nueva DevoluciÃ³n
    </button>
  </div>

  <!-- Formulario de DevoluciÃ³n -->
  <div class="form-container" *ngIf="modoFormulario">
    <h2>Procesar DevoluciÃ³n</h2>
    
    <div class="alert alert-error" *ngIf="mensajeError">
      {{ mensajeError }}
    </div>

    <form>
      <div class="form-group">
        <label for="alquilerId">Alquiler Activo *</label>
        <select 
          id="alquilerId" 
          [(ngModel)]="devolucionForm.alquilerId" 
          name="alquilerId"
          required>
          <option value="">Seleccione un alquiler</option>
          <option *ngFor="let alquiler of alquileresActivos" [value]="alquiler.id">
            {{ getAlquilerInfo(alquiler.id) }} - Fecha tentativa: {{ alquiler.fechaTentativaDevolucion | date:'dd/MM/yyyy' }}
          </option>
        </select>
      </div>

      <div class="form-group">
        <label for="fechaDevolucionReal">Fecha Real de DevoluciÃ³n *</label>
        <input 
          type="date" 
          id="fechaDevolucionReal" 
          [(ngModel)]="devolucionForm.fechaDevolucionReal" 
          name="fechaDevolucionReal"
          required>
      </div>

      <div class="form-group">
        <label for="observaciones">Observaciones</label>
        <textarea 
          id="observaciones" 
          [(ngModel)]="devolucionForm.observaciones" 
          name="observaciones"
          rows="3"
          placeholder="Estado del vehÃ­culo, comentarios adicionales..."></textarea>
      </div>

      <div class="form-actions">
        <button type="button" class="btn-primary" (click)="procesarDevolucion()">
          ğŸ’¾ Procesar DevoluciÃ³n
        </button>
        <button type="button" class="btn-secondary" (click)="cancelar()">
          âŒ Cancelar
        </button>
      </div>
    </form>
  </div>

  <!-- Lista de Devoluciones -->
  <div class="devoluciones-lista">
    <h2>Historial de Devoluciones</h2>
    
    <div class="alert alert-info" *ngIf="devoluciones.length === 0">
      No hay devoluciones registradas
    </div>

    <div class="devoluciones-grid" *ngIf="devoluciones.length > 0">
      <div class="devolucion-card" *ngFor="let devolucion of devoluciones">
        <div class="card-header">
          <h3>{{ getNombreCliente(devolucion.alquilerId) }}</h3>
          <span class="badge" [ngClass]="getClaseRetraso(devolucion.diasRetraso)">
            <span *ngIf="devolucion.diasRetraso === 0">âœ… A tiempo</span>
            <span *ngIf="devolucion.diasRetraso > 0">âš ï¸ {{ devolucion.diasRetraso }} dÃ­as de retraso</span>
          </span>
        </div>

        <div class="card-body">
          <p><strong>ğŸï¸ VehÃ­culo:</strong> {{ getNombreMoto(devolucion.alquilerId) }}</p>
          <p><strong>ğŸ“… Fecha DevoluciÃ³n:</strong> {{ devolucion.fechaDevolucionReal | date:'dd/MM/yyyy HH:mm' }}</p>
          
          <div class="costos-detalle">
            <div class="seccion-alquiler">
              <h4 style="color: #ffd700; margin-bottom: 10px;">ğŸ“Š Resumen Recalculado</h4>
              
              <div class="costo-item">
                <span>ğŸ“… DÃ­as Totales ({{ devolucion.diasRetraso > 0 ? 'originales + retraso' : 'sin retraso' }}):</span>
                <span class="valor-base">{{ devolucion.diasTotales }} dÃ­as</span>
              </div>

              <div class="costo-item">
                <span>ğŸ’µ Importe Recalculado:</span>
                <span class="valor-base">${{ devolucion.importeRecalculado.toFixed(2) }}</span>
              </div>

              <div class="costo-item" *ngIf="devolucion.descuentoUsoExtendido > 0">
                <span>ğŸ“… Desc. Uso Extendido (15%):</span>
                <span class="valor-positivo">-${{ devolucion.descuentoUsoExtendido.toFixed(2) }}</span>
              </div>

              <div class="costo-item" *ngIf="devolucion.descuentoClienteFrecuente > 0">
                <span>â­ Desc. Cliente Frecuente (10%):</span>
                <span class="valor-positivo">-${{ devolucion.descuentoClienteFrecuente.toFixed(2) }}</span>
              </div>

              <div class="costo-item" *ngIf="devolucion.depositoRecalculado > 0">
                <span>ğŸ”’ DepÃ³sito Recalculado (12%):</span>
                <span class="valor-deposito">+${{ devolucion.depositoRecalculado.toFixed(2) }}</span>
              </div>

              <div class="costo-item" *ngIf="devolucion.multaPorRetraso > 0">
                <span>ğŸ’¸ Multa por Retraso ({{ devolucion.diasRetraso }} dÃ­as + 10%):</span>
                <span class="valor-negativo">+${{ devolucion.multaPorRetraso.toFixed(2) }}</span>
              </div>

              <div class="costo-item total-destacado">
                <span><strong>ğŸ“Š Subtotal:</strong></span>
                <span class="valor-subtotal">${{ devolucion.subtotalRecalculado.toFixed(2) }}</span>
              </div>
            </div>

            <hr style="margin: 15px 0; border: 2px solid #ffd700;">
            
            <div class="seccion-deposito">
              <h4 style="color: #00ff00; margin-bottom: 10px;">ğŸ”“ GestiÃ³n del DepÃ³sito</h4>
              
              <div class="costo-item" *ngIf="devolucion.depositoDevuelto > 0">
                <span>ğŸ’š DepÃ³sito Devuelto al Cliente:</span>
                <span class="valor-positivo">${{ devolucion.depositoDevuelto.toFixed(2) }}</span>
              </div>

              <div class="costo-item" *ngIf="devolucion.depositoDevuelto === 0 && devolucion.diasRetraso > 0">
                <span>âš ï¸ DepÃ³sito Retenido (aplicado a deuda):</span>
                <span class="valor-retenido">$0.00</span>
              </div>

              <div class="info-box" *ngIf="devolucion.diasRetraso === 0">
                <p>âœ¨ DevoluciÃ³n perfecta: Se devuelve el depÃ³sito completo</p>
              </div>
            </div>
          </div>

          <p *ngIf="devolucion.observaciones" class="observaciones">
            <strong>ğŸ“ Observaciones:</strong> {{ devolucion.observaciones }}
          </p>
        </div>

        <div class="card-footer">
          <button class="btn-danger" (click)="eliminarDevolucion(devolucion.id)">
            ğŸ—‘ï¸ Eliminar
          </button>
        </div>
      </div>
    </div>
  </div>
</div>
